{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>Admin Dashboard</h2>
        <p class="text-muted">FaciliBook Management System</p>
    </div>
</div>

<div class="row mb-4">
    
    <div class="col-md-7">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold d-flex justify-content-between align-items-center">
                <span>Facility Utilization</span>
                
                <div class="d-flex gap-2">
                    <select id="utilizationFilter" class="form-select form-select-sm" style="width: 140px;">
                        <option value="weekly">This Week</option>
                        <option value="monthly" selected>Specific Month</option>
                    </select>

                    <input type="month" id="historyPicker" class="form-control form-control-sm" style="width: 150px;">
                </div>
            </div>
            <div class="card-body">
                <div style="height: 250px;">
                    <canvas id="facilityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-5">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">Request Status</div>
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div style="width: 50%; height: 200px;">
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="ms-4">
                        <ul class="list-unstyled mb-0" id="statusLegend"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-5">
    <div class="col-md-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white fw-bold">Average User Rating per Facility (Out of 5.0)</div>
            <div class="card-body">
                <div style="height: 250px;"><canvas id="feedbackChart"></canvas></div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-5">
    <div class="col-md-3"><div class="card h-100 shadow-sm text-center border-0 bg-primary text-white"><div class="card-body p-3"><h2><i class="fa-solid fa-building"></i></h2><div class="fw-bold mt-2">Facilities</div><a href="{{ url_for('manage_facilities') }}" class="stretched-link"></a></div></div></div>
    <div class="col-md-3"><div class="card h-100 shadow-sm text-center border-0 bg-warning text-dark"><div class="card-body p-3"><h2><i class="fa-solid fa-clipboard-check"></i></h2><div class="fw-bold mt-2">Approvals</div><a href="{{ url_for('admin_bookings') }}" class="stretched-link"></a></div></div></div>
    <div class="col-md-3"><div class="card h-100 shadow-sm text-center border-0 bg-success text-white"><div class="card-body p-3"><h2><i class="fa-solid fa-print"></i></h2><div class="fw-bold mt-2">Reports</div><a href="{{ url_for('admin_reports') }}" class="stretched-link"></a></div></div></div>
    <div class="col-md-3"><div class="card h-100 shadow-sm text-center border-0 bg-info text-dark"><div class="card-body p-3"><h2><i class="fa-solid fa-comments"></i></h2><div class="fw-bold mt-2">Feedback</div><a href="{{ url_for('admin_feedback') }}" class="stretched-link"></a></div></div></div>
</div>
<div class="py-4"></div>

{% endblock %}

{% block scripts %}
<script>
    // 1. Set Default Date to Current Month in the Picker
    const today = new Date();
    const currentMonth = today.toISOString().slice(0, 7); // Format: YYYY-MM
    document.getElementById('historyPicker').value = currentMonth;

    // 2. Main Load Function
    function loadDashboard(targetMonth) {
        // Fetch data with the selected month param
        const url = targetMonth ? `/api/stats?month=${targetMonth}` : '/api/stats';
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                updateCharts(data);
            });
    }

    let facilityChart; // Global var to allow updates

    function updateCharts(data) {
        // --- A. FACILITY CHART ---
        const ctxFac = document.getElementById('facilityChart').getContext('2d');
        const labels = data.weekly.map(i => i.name);
        
        // Decide which data to show based on dropdown
        const filterType = document.getElementById('utilizationFilter').value;
        const chartData = (filterType === 'weekly') ? data.weekly.map(i => i.count) : data.monthly.map(i => i.count);
        
        if(facilityChart) {
            facilityChart.destroy(); // Destroy old chart before making new one
        }

        facilityChart = new Chart(ctxFac, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Bookings',
                    data: chartData,
                    backgroundColor: '#4e73df',
                    borderRadius: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
        });

        // --- B. STATUS CHART (Only render if not exists to avoid flicker) ---
        if(!Chart.getChart("statusChart")){
            const statusLabels = data.statuses.map(i => i.status);
            const statusCounts = data.statuses.map(i => i.count);
            const colorMap = { 'approved': '#198754', 'rejected': '#dc3545', 'pending': '#ffc107' };
            const bgColors = statusLabels.map(s => colorMap[s] || '#ccc');

            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: { labels: statusLabels, datasets: [{ data: statusCounts, backgroundColor: bgColors, borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
            });

            const legendContainer = document.getElementById('statusLegend');
            legendContainer.innerHTML = ''; // Clear first
            data.statuses.forEach(item => {
                const color = colorMap[item.status] || '#ccc';
                const label = item.status.charAt(0).toUpperCase() + item.status.slice(1);
                legendContainer.innerHTML += `<li class="mb-2 d-flex align-items-center fw-bold"><span style="width:12px; height:12px; background-color:${color}; display:inline-block; margin-right:8px; border-radius:50%;"></span>${label}: <span class="ms-2 text-dark">${item.count}</span></li>`;
            });
        }

        // --- C. FEEDBACK CHART (Only render if not exists) ---
        if(!Chart.getChart("feedbackChart")){
            const ratingColors = data.feedbacks.map(item => item.avg_rating >= 4.0 ? '#198754' : (item.avg_rating >= 2.5 ? '#ffc107' : '#dc3545'));
            new Chart(document.getElementById('feedbackChart'), {
                type: 'bar',
                data: { labels: data.feedbacks.map(i => i.name), datasets: [{ label: 'Average Score', data: data.feedbacks.map(i => i.avg_rating), backgroundColor: ratingColors, borderRadius: 5 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { min: 0, max: 5, ticks: { stepSize: 1 } } } }
            });
        }
    }

    // --- EVENT LISTENERS ---
    
    // 1. Dropdown Change (Weekly vs Monthly)
    document.getElementById('utilizationFilter').addEventListener('change', function() {
        const picker = document.getElementById('historyPicker');
        if (this.value === 'weekly') {
            picker.style.display = 'none'; // Hide picker
            loadDashboard(); // Reload (API will ignore month param)
        } else {
            picker.style.display = 'block'; // Show picker
            loadDashboard(picker.value); // Load selected month
        }
    });

    // 2. Date Picker Change
    document.getElementById('historyPicker').addEventListener('change', function() {
        // Ensure dropdown is set to monthly
        document.getElementById('utilizationFilter').value = 'monthly';
        loadDashboard(this.value);
    });

    // Initial Load
    loadDashboard(currentMonth);

</script>
{% endblock %}